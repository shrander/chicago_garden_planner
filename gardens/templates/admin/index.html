{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" href="{% static "admin/css/dashboard.css" %}">{% endblock %}

{% block coltype %}colMS{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block nav-sidebar %}{% endblock %}

{% block content %}
<div id="content-main">
    <!-- System Statistics Dashboard at Top -->
    <div style="margin-bottom: 30px;">
        <h2>System Overview</h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Active Users Card -->
            <div class="module">
                <table style="width: 100%;">
                    <caption style="text-align: left; padding: 10px; background: #417690; color: white; font-weight: bold;">
                        <span style="font-size: 18px;">ðŸ‘¥</span> Active Users
                    </caption>
                    <tbody>
                        <tr>
                            <td style="padding: 15px;">
                                <div style="font-size: 42px; font-weight: bold; color: #417690; text-align: center; margin: 10px 0;">
                                    {{ active_user_count }}
                                </div>
                                {% if active_users %}
                                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                    <strong>Currently online:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px;">
                                        {% for user in active_users %}
                                        <li style="margin: 3px 0;">{{ user.username }}{% if user.is_superuser %} <span style="color: #ba2121; font-weight: bold;">(Admin)</span>{% endif %}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                <div style="font-size: 11px; color: #999; margin-top: 15px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                    Total: {{ user_stats.total }} | Staff: {{ user_stats.staff }} | Admins: {{ user_stats.superusers }}
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- System Resources Card -->
            <div class="module">
                <table style="width: 100%;">
                    <caption style="text-align: left; padding: 10px; background: #79aec8; color: white; font-weight: bold;">
                        <span style="font-size: 18px;">ðŸ’»</span> System Resources
                    </caption>
                    <tbody>
                        <tr>
                            <td style="padding: 15px;">
                                {% if system_stats.error %}
                                    <p style="color: #ba2121; padding: 10px; background: #fee; border-radius: 4px;">Error: {{ system_stats.error }}</p>
                                {% else %}
                                    <div style="margin: 12px 0;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
                                            <span><strong>CPU:</strong></span>
                                            <span style="color: {% if system_stats.cpu_percent > 80 %}#ba2121{% elif system_stats.cpu_percent > 50 %}#e67e00{% else %}#417690{% endif %}; font-weight: bold;">{{ system_stats.cpu_percent|floatformat:1 }}%</span>
                                        </div>
                                        <div style="background: #e1e1e1; height: 16px; border-radius: 8px; overflow: hidden; border: 1px solid #ccc;">
                                            <div style="background: {% if system_stats.cpu_percent > 80 %}#ba2121{% elif system_stats.cpu_percent > 50 %}#ffc107{% else %}#417690{% endif %}; height: 100%; width: {{ system_stats.cpu_percent }}%; transition: width 0.3s;"></div>
                                        </div>
                                    </div>

                                    <div style="margin: 12px 0;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
                                            <span><strong>Memory:</strong></span>
                                            <span style="color: {% if system_stats.memory_percent > 80 %}#ba2121{% elif system_stats.memory_percent > 50 %}#e67e00{% else %}#79aec8{% endif %}; font-weight: bold;">{{ system_stats.memory_percent|floatformat:1 }}%</span>
                                        </div>
                                        <div style="background: #e1e1e1; height: 16px; border-radius: 8px; overflow: hidden; border: 1px solid #ccc;">
                                            <div style="background: {% if system_stats.memory_percent > 80 %}#ba2121{% elif system_stats.memory_percent > 50 %}#ffc107{% else %}#79aec8{% endif %}; height: 100%; width: {{ system_stats.memory_percent }}%; transition: width 0.3s;"></div>
                                        </div>
                                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                                            {{ system_stats.memory_used_gb|floatformat:1 }} / {{ system_stats.memory_total_gb|floatformat:1 }} GB
                                        </div>
                                    </div>

                                    <div style="margin: 12px 0;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
                                            <span><strong>Disk:</strong></span>
                                            <span style="color: {% if system_stats.disk_percent > 80 %}#ba2121{% elif system_stats.disk_percent > 50 %}#e67e00{% else %}#79aec8{% endif %}; font-weight: bold;">{{ system_stats.disk_percent|floatformat:1 }}%</span>
                                        </div>
                                        <div style="background: #e1e1e1; height: 16px; border-radius: 8px; overflow: hidden; border: 1px solid #ccc;">
                                            <div style="background: {% if system_stats.disk_percent > 80 %}#ba2121{% elif system_stats.disk_percent > 50 %}#ffc107{% else %}#79aec8{% endif %}; height: 100%; width: {{ system_stats.disk_percent }}%; transition: width 0.3s;"></div>
                                        </div>
                                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                                            {{ system_stats.disk_used_gb|floatformat:1 }} / {{ system_stats.disk_total_gb|floatformat:1 }} GB
                                        </div>
                                    </div>

                                    <div style="font-size: 11px; color: #999; margin-top: 15px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                        {{ system_stats.platform }} {{ system_stats.platform_release }} | Python {{ system_stats.python_version }}
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Application Statistics Card -->
            <div class="module">
                <table style="width: 100%;">
                    <caption style="text-align: left; padding: 10px; background: #6c9b6c; color: white; font-weight: bold;">
                        <span style="font-size: 18px;">ðŸŒ±</span> Application Data
                    </caption>
                    <tbody>
                        <tr>
                            <td style="padding: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center;">
                                    <div>
                                        <div style="font-size: 36px; font-weight: bold; color: #6c9b6c; margin-bottom: 8px;">{{ app_stats.total_gardens }}</div>
                                        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Gardens</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 36px; font-weight: bold; color: #6c9b6c; margin-bottom: 8px;">{{ app_stats.total_plant_instances }}</div>
                                        <div style="font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Planted</div>
                                    </div>
                                </div>
                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 13px; color: #666;">Total Plants:</span>
                                        <span style="font-size: 24px; font-weight: bold; color: #6c9b6c;">{{ app_stats.total_plants }}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #999;">
                                        <span>System Default:</span>
                                        <span style="color: #417690; font-weight: bold;">{{ app_stats.default_plants }}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #999; margin-top: 3px;">
                                        <span>Custom:</span>
                                        <span style="color: #79aec8; font-weight: bold;">{{ app_stats.custom_plants }}</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Three Column Layout: App List (Left), System Stats (Center), Recent Actions (Right) -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
        <!-- Left Column: App List -->
        <div>
            {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
        </div>

        <!-- Middle Column: Additional Stats or Info -->
        <div>
            <div class="module">
                <table style="width: 100%;">
                    <caption>
                        <span>ðŸ“Š Quick Stats</span>
                    </caption>
                    <tbody>
                        <tr>
                            <td style="padding: 15px;">
                                <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 13px; color: #666;">Total Gardens</span>
                                        <span style="font-size: 20px; font-weight: bold; color: #417690;">{{ app_stats.total_gardens }}</span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 13px; color: #666;">Plants in Library</span>
                                        <span style="font-size: 20px; font-weight: bold; color: #417690;">{{ app_stats.total_plants }}</span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 13px; color: #666;">Active Plantings</span>
                                        <span style="font-size: 20px; font-weight: bold; color: #417690;">{{ app_stats.total_plant_instances }}</span>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 13px; color: #666;">Registered Users</span>
                                        <span style="font-size: 20px; font-weight: bold; color: #417690;">{{ user_stats.total }}</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: Recent Actions -->
        <div>
            {% load log %}
            {% get_admin_log 10 as admin_log for_user user %}
            <div class="module">
                <table style="width: 100%;">
                    <caption>
                        <span>{% trans 'Recent actions' %}</span>
                    </caption>
                    <tbody>
                        <tr>
                            <td>
                                {% if not admin_log %}
                                <p style="padding: 15px; color: #666;">{% trans 'None available' %}</p>
                                {% else %}
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    {% for entry in admin_log %}
                                    <li style="padding: 10px 15px; border-bottom: 1px solid #e0e0e0;">
                                        {% if entry.is_deletion %}
                                            <span style="color: #ba2121;">{% trans 'Deleted' %}</span>
                                        {% elif entry.is_change %}
                                            <span style="color: #e67e00;">{% trans 'Changed' %}</span>
                                        {% elif entry.is_addition %}
                                            <span style="color: #417690;">{% trans 'Added' %}</span>
                                        {% endif %}

                                        {% if entry.content_type %}
                                            <span style="font-size: 12px; color: #666;">
                                                {{ entry.content_type.name }}
                                            </span>
                                        {% endif %}

                                        {% if not entry.is_deletion %}
                                            <a href="{{ entry.get_admin_url }}" style="display: block; margin-top: 3px;">
                                                {{ entry.object_repr }}
                                            </a>
                                        {% else %}
                                            <span style="display: block; margin-top: 3px; color: #999;">
                                                {{ entry.object_repr }}
                                            </span>
                                        {% endif %}

                                        <span style="font-size: 11px; color: #999; display: block; margin-top: 3px;">
                                            {{ entry.action_time|timesince }} ago
                                        </span>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
