{% extends "gardens/base.html" %}
{% load garden_filters %}
{% load static %}

{% block title %}{{ garden.name }} - Chicago Garden Planner{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'gardens:garden_list' %}">Gardens</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ garden.name }}</li>
            </ol>
        </nav>
        {% if can_edit %}
        <h1 class="display-5" id="gardenNameDisplay" style="cursor: pointer;" title="Click to edit">
            {{ garden.name }}
            <i class="bi bi-pencil-square ms-2" style="font-size: 0.7em; color: #6c757d;"></i>
        </h1>
        <input type="text"
               id="gardenNameInput"
               class="form-control form-control-lg d-none"
               value="{{ garden.name }}"
               maxlength="100">
        <span id="gardenNameSaveStatus" class="badge ms-2"></span>
        {% else %}
        <h1 class="display-5">{{ garden.name }}</h1>
        {% endif %}
        <p class="text-muted">
            <i class="bi bi-person"></i> Created by {{ garden.owner.username }}
            &nbsp;|&nbsp;
            <i class="bi bi-clock"></i> Updated {{ garden.updated_at|date:"F d, Y" }}
        </p>
    </div>
    <div class="col-md-4 text-end">
        {% if can_edit %}
        <div class="btn-group mb-2" role="group">
            {% if not has_api_key %}
            <div class="d-inline-block" data-bs-toggle="tooltip" data-bs-html="true" data-bs-placement="bottom"
                 title="API key not configured. <a href='{% url 'accounts:profile' %}' class='text-white text-decoration-underline'>Go to Profile Settings</a> to add your Anthropic API key.">
                <button type="button" class="btn btn-success" id="aiAssistantBtn" disabled style="pointer-events: none;">
                    <i class="bi bi-robot"></i> AI Suggestions
                </button>
            </div>
            {% else %}
            <button type="button" class="btn btn-success" id="aiAssistantBtn">
                <i class="bi bi-robot"></i> AI Suggestions
            </button>
            {% endif %}
            <button type="button" class="btn btn-outline-primary" id="exportGardenBtn">
                <i class="bi bi-clipboard"></i> Export for LLM
            </button>
            <button type="button" class="btn btn-outline-primary" id="importLayoutBtn">
                <i class="bi bi-download"></i> Import Layout
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-info" id="shareGardenBtn">
                <i class="bi bi-share"></i> Share
            </button>
            <button type="button" class="btn btn-outline-warning" id="clearGardenBtn">
                <i class="bi bi-eraser"></i> Clear Layout
            </button>
            <button type="button" class="btn btn-outline-success" id="duplicateGardenBtn">
                <i class="bi bi-copy"></i> Duplicate
            </button>
            <button type="button" class="btn btn-outline-danger" id="deleteGardenBtn">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals -->
{% include 'gardens/partials/_delete_confirm_modal.html' %}
{% include 'gardens/partials/_clear_confirm_modal.html' %}

{% if can_edit %}
{% include 'gardens/partials/_share_modal.html' %}
{% include 'gardens/partials/_ai_assistant_modal.html' %}
{% include 'gardens/partials/_export_modal.html' %}
{% include 'gardens/partials/_import_modal.html' %}
{% include 'gardens/partials/_plant_date_modal.html' %}
{% endif %}

<!-- Garden Grid and Plant Library Side by Side -->
<div class="row mb-4">
    <!-- Garden Grid (Left Column) -->
    <div class="{% if can_edit %}col-md-8{% else %}col-md-12{% endif %}">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Garden Layout</h5>
                </div>
                {% if can_edit %}
                <div>
                    <span id="saveStatus" class="badge bg-secondary ms-2"></span>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if grid_data %}
                <div class="table-responsive">
                    <table class="table table-bordered garden-grid" id="gardenGrid" style="table-layout: fixed; width: auto; margin: 0 auto;">
                        {% for row in grid_data %}
                        <tr data-row="{{ forloop.counter0 }}">
                            {% for cell in row %}
                            <td class="garden-cell text-center p-1 {% if can_edit %}droppable{% endif %}"
                                data-row="{{ forloop.parentloop.counter0 }}"
                                data-col="{{ forloop.counter0 }}"
                                data-plant="{{ cell|lower }}"
                                style="position: relative;">
                                {% if cell %}
                                    {% if cell == 'path' or cell == '=' %}
                                    <span class="cell-content badge bg-secondary w-100 h-100 d-flex align-items-center justify-content-center"
                                          style="font-size: 1.5rem; border-radius: 4px;">=</span>
                                    {% elif cell == 'empty space' or cell == '•' %}
                                    <span class="cell-content badge bg-light text-muted w-100 h-100 d-flex align-items-center justify-content-center"
                                          style="font-size: 1.5rem; border-radius: 4px;">•</span>
                                    {% else %}
                                        {% with plant_info=plant_map|get_plant_info:cell %}
                                        <span class="cell-content badge w-100 h-100 d-flex align-items-center justify-content-center"
                                              style="background-color: {% if plant_info %}{{ plant_info.color }}{% else %}#90EE90{% endif %}; color: white; font-size: 1.8rem; font-weight: bold; border-radius: 4px;"
                                              title="{% if plant_info %}{{ plant_info.name }}{% else %}{{ cell }}{% endif %}"
                                              data-plant-name="{{ cell|lower }}">
                                            {% if plant_info %}{{ plant_info.symbol }}{% else %}{{ cell|slice:":1"|upper }}{% endif %}
                                        </span>
                                        {% endwith %}
                                    {% endif %}
                                {% else %}
                                <span class="cell-content badge bg-light text-muted w-100 h-100 d-flex align-items-center justify-content-center"
                                      style="font-size: 1.5rem; border-radius: 4px;">•</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No layout data available for this garden.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Plant Library Sidebar (Right Column) -->
    {% if can_edit %}
    <div class="col-md-4">
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-flower1"></i> Plant Library</h5>
                <small>Drag plants to garden or drag off to remove</small>
            </div>
            <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
                <div id="plantLibrary">
                    {% for plant in utility_plants %}
                    <div class="plant-item draggable mb-2 p-2 border rounded d-flex align-items-center"
                         draggable="true"
                         data-plant-name="{{ plant.name|lower }}"
                         data-plant-symbol="{{ plant.symbol }}"
                         data-plant-color="{{ plant.color }}"
                         style="cursor: move; background-color: #f8f9fa;">
                        <div class="d-flex align-items-center justify-content-center me-2"
                             style="min-width: 50px; min-height: 50px; background-color: {{ plant.color }}; color: white; font-size: 1.5rem; font-weight: bold; border-radius: 4px;">
                            {{ plant.symbol }}
                        </div>
                        <div class="flex-grow-1">
                            <strong>{{ plant.name }}</strong>
                            <br>
                            <small class="text-muted">{{ plant.chicago_notes|truncatechars:30 }}</small>
                        </div>
                    </div>
                    {% endfor %}
                    <hr>
                    {% for plant in all_plants %}
                    <div class="plant-item draggable mb-2 p-2 border rounded d-flex align-items-center"
                         draggable="true"
                         data-plant-name="{{ plant.name|lower }}"
                         data-plant-symbol="{{ plant.symbol }}"
                         data-plant-color="{{ plant.color }}"
                         style="cursor: move; background-color: #f8f9fa;">
                        <div class="d-flex align-items-center justify-content-center me-2"
                             style="min-width: 50px; min-height: 50px; background-color: {{ plant.color }}; color: white; font-size: 1.5rem; font-weight: bold; border-radius: 4px;">
                            {{ plant.symbol }}
                        </div>
                        <div class="flex-grow-1">
                            <strong>{{ plant.name }}</strong>
                            <br>
                            <small class="text-muted">{{ plant.latin_name|truncatechars:25 }}</small>
                        </div>
                        <div>
                            <small class="badge bg-secondary">{{ plant.get_plant_type_display }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Garden Info and Plant Library Side by Side -->
<div class="row mb-4">
    <!-- Garden Info (Left Column) -->
    <div class="{% if can_edit %}col-md-8{% else %}col-md-12{% endif %}">
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Garden Information</h5>
            </div>
            <div class="card-body">
                <p class="card-text">{{ garden.description|default:"No description provided." }}</p>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <h6 class="text-muted">Size</h6>
                        <p><span class="badge bg-primary">{{ garden.get_size_display }}</span></p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Dimensions</h6>
                        <p><strong>{{ garden.width }}' × {{ garden.height }}'</strong></p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Total Plants</h6>
                        <p><i class="bi bi-flower1 text-success"></i> <strong>{{ garden.get_plant_count }}</strong></p>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-md-4">
                        <h6 class="text-muted">Visibility</h6>
                        <p>
                            {% if garden.is_public %}
                            <span class="badge bg-info"><i class="bi bi-globe"></i> Public</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-lock"></i> Private</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Grid Spaces</h6>
                        <p><strong>{{ grid_data|length }} × {% if grid_data %}{{ grid_data.0|length }}{% else %}0{% endif %}</strong></p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Fill Rate</h6>
                        <p>{{ fill_rate|floatformat:0 }}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Garden Statistics -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Garden Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="text-muted">Plant Diversity</h6>
                        <p class="h4 text-success"><i class="bi bi-stars"></i> {{ diversity }}</p>
                        <small class="text-muted">unique species</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Total Planted</h6>
                        <p class="h4 text-primary">{{ plant_count }}</p>
                        <small class="text-muted">of {{ total_spaces }} cells</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Fill Rate</h6>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: {{ fill_rate|floatformat:0 }}%"
                                 aria-valuenow="{{ fill_rate|floatformat:0 }}"
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ fill_rate|floatformat:1 }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Available Space</h6>
                        <p class="h4 text-warning">{{ empty_cells_count }}</p>
                        <small class="text-muted">empty cells</small>
                    </div>
                </div>

                {% if plant_type_stats_detail %}
                <hr class="my-3">
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="text-muted mb-3"><i class="bi bi-diagram-3"></i> Breakdown by Type</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for plant_type, count in plant_type_stats_detail.items %}
                            <span class="badge bg-secondary fs-6">
                                {{ count }} {{ plant_type|title }}{{ count|pluralize }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if plant_counts_detail %}
                <hr class="my-3">
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="text-muted mb-3"><i class="bi bi-basket"></i> Estimated Yield</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Plant</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-center">Yield/Plant</th>
                                        <th class="text-end">Total Estimated Yield</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for plant, count in plant_counts_detail.items %}
                                    <tr>
                                        <td class="text-capitalize">{{ plant }}</td>
                                        <td class="text-center"><strong>{{ count }}</strong></td>
                                        <td class="text-center">
                                            {% with plant_obj=plant_yields|get_item:plant %}
                                                {% if plant_obj.yield_per_plant %}
                                                    <span class="badge bg-light text-dark">{{ plant_obj.yield_per_plant }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td class="text-end text-success">
                                            {% with plant_obj=plant_yields|get_item:plant %}
                                                {% if plant_obj.yield_per_plant %}
                                                    <strong>{{ plant_obj.yield_per_plant|calculate_total_yield:count }}</strong>
                                                {% else %}
                                                    <span class="text-muted">No estimate</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if path_cells_count > 0 %}
                <hr class="my-3">
                <div class="row">
                    <div class="col-md-12">
                        <p class="mb-0 text-muted">
                            <i class="bi bi-signpost-split"></i>
                            <strong>{{ path_cells_count }}</strong> cell{{ path_cells_count|pluralize }} designated as path{{ path_cells_count|pluralize }}
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Notes -->
        {% if notes %}
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> Recent Planting Notes</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for note in notes %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ note.title|default:"Note" }}</h6>
                            <small class="text-muted">{{ note.note_date|date:"M d, Y" }}</small>
                        </div>
                        <p class="mb-1">{{ note.note_text|truncatewords:30 }}</p>
                        <small class="text-muted">
                            {% if note.plant %}
                            <i class="bi bi-flower1"></i> {{ note.plant.name }}
                            {% endif %}
                            {% if note.grid_position %}
                            &nbsp;|&nbsp; <i class="bi bi-geo-alt"></i> {{ note.grid_position %}
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'gardens/css/garden-detail.css' %}">
{% endblock %}

{% block extra_js %}
<!-- Load utility functions -->
<script src="{% static 'gardens/js/utils.js' %}"></script>

{% if can_edit %}
<script>
// Pass data from Django template to JavaScript
window.GARDEN_ID = {{ garden.pk }};
window.PLANT_MAP = {{ plant_map_json|safe }};
window.INSTANCE_MAP = {{ instance_map_json|safe }};
window.GARDEN_DATA = {
    width: {{ garden.width }},
    height: {{ garden.height }},
    plantDatabase: {{ plant_database_json|safe }},
    userZone: '{{ user_zone }}',
    {% if frost_dates %}
    lastFrostDate: '{{ frost_dates.last_frost|date:"F j" }}',
    firstFrostDate: '{{ frost_dates.first_frost|date:"F j" }}',
    {% endif %}
    {% if climate_info %}
    growingSeasonDays: {{ climate_info.growing_season_days }},
    specialConsiderations: '{{ climate_info.special_considerations|escapejs }}'
    {% endif %}
};
</script>

<!-- Load external JavaScript modules -->
<script src="{% static 'gardens/js/api.js' %}"></script>
<script src="{% static 'gardens/js/garden-detail.js' %}"></script>
<script src="{% static 'gardens/js/date-management.js' %}"></script>

<script>
// ========================================
// ALL GARDEN DETAIL INTERACTIVITY
// ========================================
// All JavaScript functionality for this page has been extracted to external modules:
//
// garden-detail.js:
//   - Drag-and-drop plant placement
//   - Auto-save garden layout
//   - Garden name inline editing
//   - AI assistant integration
//   - Export/import functionality
//   - Modal handlers (delete, duplicate, clear)
//
// api.js:
//   - Centralized GardenAPI client for all backend operations
//
// utils.js:
//   - Reusable utilities (CSRF tokens, fetch wrapper, ButtonStateManager)
//
// This architecture provides:
//   ✓ Clean, maintainable template
//   ✓ Better code organization and reusability
//   ✓ Browser caching benefits for JS files
//   ✓ Easier testing and debugging
</script>
{% endif %}
{% endblock %}