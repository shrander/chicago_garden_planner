{% extends "gardens/base.html" %}
{% load garden_filters %}

{% block title %}{{ garden.name }} - Chicago Garden Planner{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'gardens:garden_list' %}">Gardens</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ garden.name }}</li>
            </ol>
        </nav>
        {% if can_edit %}
        <h1 class="display-5" id="gardenNameDisplay" style="cursor: pointer;" title="Click to edit">
            {{ garden.name }}
            <i class="bi bi-pencil-square ms-2" style="font-size: 0.7em; color: #6c757d;"></i>
        </h1>
        <input type="text"
               id="gardenNameInput"
               class="form-control form-control-lg d-none"
               value="{{ garden.name }}"
               maxlength="100">
        <span id="gardenNameSaveStatus" class="badge ms-2"></span>
        {% else %}
        <h1 class="display-5">{{ garden.name }}</h1>
        {% endif %}
        <p class="text-muted">
            <i class="bi bi-person"></i> Created by {{ garden.owner.username }}
            &nbsp;|&nbsp;
            <i class="bi bi-clock"></i> Updated {{ garden.updated_at|date:"F d, Y" }}
        </p>
    </div>
    <div class="col-md-4 text-end">
        {% if can_edit %}
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-success" id="aiAssistantBtn">
                <i class="bi bi-robot"></i> AI Suggestions
            </button>
            <button type="button" class="btn btn-outline-success" id="duplicateGardenBtn">
                <i class="bi bi-copy"></i> Duplicate
            </button>
            <button type="button" class="btn btn-outline-danger" id="deleteGardenBtn">
                <i class="bi bi-trash"></i> Delete
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>"{{ garden.name }}"</strong>?</p>
                <p class="text-danger">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'gardens:garden_delete' garden.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete Garden
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AI Assistant Modal -->
{% if can_edit %}
<div class="modal fade" id="aiAssistantModal" tabindex="-1" aria-labelledby="aiAssistantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="aiAssistantModalLabel">
                    <i class="bi bi-robot"></i> AI Garden Assistant
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="aiAssistantBody">
                <div class="text-center py-5" id="aiLoadingState">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Claude is analyzing your garden...</p>
                </div>
                <div id="aiSuggestionsContent" class="d-none">
                    <div class="alert alert-info">
                        <strong><i class="bi bi-lightbulb"></i> Strategy:</strong>
                        <p id="aiReasoning" class="mb-0 mt-2"></p>
                    </div>
                    <h6 class="mt-3"><i class="bi bi-flower1"></i> Suggested Plants:</h6>
                    <div id="aiSuggestionsList" class="list-group mt-2"></div>
                </div>
                <div id="aiErrorState" class="d-none">
                    <div class="alert alert-danger">
                        <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong>
                        <p id="aiErrorMessage" class="mb-0 mt-2"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="applyAllSuggestionsBtn" disabled>
                    <i class="bi bi-check-circle"></i> Apply All Suggestions
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Garden Grid and Plant Library Side by Side -->
<div class="row mb-4">
    <!-- Garden Grid (Left Column) -->
    <div class="{% if can_edit %}col-md-8{% else %}col-md-12{% endif %}">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Garden Layout</h5>
                </div>
                {% if can_edit %}
                <div>
                    <span id="saveStatus" class="badge bg-secondary ms-2"></span>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if grid_data %}
                <div class="table-responsive">
                    <table class="table table-bordered garden-grid" id="gardenGrid" style="width: auto; margin: 0 auto;">
                        {% for row in grid_data %}
                        <tr data-row="{{ forloop.counter0 }}">
                            {% for cell in row %}
                            <td class="garden-cell text-center p-1 {% if can_edit %}droppable{% endif %}"
                                data-row="{{ forloop.parentloop.counter0 }}"
                                data-col="{{ forloop.counter0 }}"
                                data-plant="{{ cell|lower }}"
                                style="width: 70px; height: 70px; position: relative;">
                                {% if cell %}
                                    {% if cell == 'path' or cell == '=' %}
                                    <span class="cell-content badge bg-secondary w-100 h-100 d-flex align-items-center justify-content-center"
                                          style="font-size: 1.5rem; border-radius: 4px;">=</span>
                                    {% elif cell == 'empty space' or cell == '•' %}
                                    <span class="cell-content badge bg-light text-muted w-100 h-100 d-flex align-items-center justify-content-center"
                                          style="font-size: 1.5rem; border-radius: 4px;">•</span>
                                    {% else %}
                                        {% with plant_info=plant_map|get_plant_info:cell %}
                                        <span class="cell-content badge w-100 h-100 d-flex align-items-center justify-content-center"
                                              style="background-color: {% if plant_info %}{{ plant_info.color }}{% else %}#90EE90{% endif %}; color: white; font-size: 1.8rem; font-weight: bold; border-radius: 4px;"
                                              title="{% if plant_info %}{{ plant_info.name }}{% else %}{{ cell }}{% endif %}"
                                              data-plant-name="{{ cell|lower }}">
                                            {% if plant_info %}{{ plant_info.symbol }}{% else %}{{ cell|slice:":1"|upper }}{% endif %}
                                        </span>
                                        {% endwith %}
                                    {% endif %}
                                {% else %}
                                <span class="cell-content badge bg-light text-muted w-100 h-100 d-flex align-items-center justify-content-center"
                                      style="font-size: 1.5rem; border-radius: 4px;">•</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No layout data available for this garden.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Plant Library Sidebar (Right Column) -->
    {% if can_edit %}
    <div class="col-md-4">
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-flower1"></i> Plant Library</h5>
                <small>Drag plants to garden or drag off to remove</small>
            </div>
            <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
                <div id="plantLibrary">
                    {% for plant in utility_plants %}
                    <div class="plant-item draggable mb-2 p-2 border rounded d-flex align-items-center"
                         draggable="true"
                         data-plant-name="{{ plant.name|lower }}"
                         data-plant-symbol="{{ plant.symbol }}"
                         data-plant-color="{{ plant.color }}"
                         style="cursor: move; background-color: #f8f9fa;">
                        <div class="d-flex align-items-center justify-content-center me-2"
                             style="min-width: 50px; min-height: 50px; background-color: {{ plant.color }}; color: white; font-size: 1.5rem; font-weight: bold; border-radius: 4px;">
                            {{ plant.symbol }}
                        </div>
                        <div class="flex-grow-1">
                            <strong>{{ plant.name }}</strong>
                            <br>
                            <small class="text-muted">{{ plant.chicago_notes|truncatechars:30 }}</small>
                        </div>
                    </div>
                    {% endfor %}
                    <hr>
                    {% for plant in all_plants %}
                    <div class="plant-item draggable mb-2 p-2 border rounded d-flex align-items-center"
                         draggable="true"
                         data-plant-name="{{ plant.name|lower }}"
                         data-plant-symbol="{{ plant.symbol }}"
                         data-plant-color="{{ plant.color }}"
                         style="cursor: move; background-color: #f8f9fa;">
                        <div class="d-flex align-items-center justify-content-center me-2"
                             style="min-width: 50px; min-height: 50px; background-color: {{ plant.color }}; color: white; font-size: 1.5rem; font-weight: bold; border-radius: 4px;">
                            {{ plant.symbol }}
                        </div>
                        <div class="flex-grow-1">
                            <strong>{{ plant.name }}</strong>
                            <br>
                            <small class="text-muted">{{ plant.latin_name|truncatechars:25 }}</small>
                        </div>
                        <div>
                            <small class="badge bg-secondary">{{ plant.get_plant_type_display }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Garden Info and Plant Library Side by Side -->
<div class="row mb-4">
    <!-- Garden Info (Left Column) -->
    <div class="{% if can_edit %}col-md-8{% else %}col-md-12{% endif %}">
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Garden Information</h5>
            </div>
            <div class="card-body">
                <p class="card-text">{{ garden.description|default:"No description provided." }}</p>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <h6 class="text-muted">Size</h6>
                        <p><span class="badge bg-primary">{{ garden.get_size_display }}</span></p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Dimensions</h6>
                        <p><strong>{{ garden.width }}' × {{ garden.height }}'</strong></p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Total Plants</h6>
                        <p><i class="bi bi-flower1 text-success"></i> <strong>{{ garden.get_plant_count }}</strong></p>
                    </div>
                </div>

                <div class="row mt-2">
                    <div class="col-md-4">
                        <h6 class="text-muted">Visibility</h6>
                        <p>
                            {% if garden.is_public %}
                            <span class="badge bg-info"><i class="bi bi-globe"></i> Public</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-lock"></i> Private</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Grid Spaces</h6>
                        <p><strong>{{ grid_data|length }} × {% if grid_data %}{{ grid_data.0|length }}{% else %}0{% endif %}</strong></p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Fill Rate</h6>
                        <p>{{ fill_rate|floatformat:0 }}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Notes -->
        {% if notes %}
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> Recent Planting Notes</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for note in notes %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ note.title|default:"Note" }}</h6>
                            <small class="text-muted">{{ note.note_date|date:"M d, Y" }}</small>
                        </div>
                        <p class="mb-1">{{ note.note_text|truncatewords:30 }}</p>
                        <small class="text-muted">
                            {% if note.plant %}
                            <i class="bi bi-flower1"></i> {{ note.plant.name }}
                            {% endif %}
                            {% if note.grid_position %}
                            &nbsp;|&nbsp; <i class="bi bi-geo-alt"></i> {{ note.grid_position %}
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.garden-grid td {
    font-size: 0.7rem;
    vertical-align: middle;
}
.garden-cell {
    position: relative;
    transition: transform 0.2s, box-shadow 0.2s;
}
.garden-cell:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 10;
}
.droppable {
    transition: background-color 0.2s;
}
.droppable.drag-over {
    background-color: #d4edda !important;
    border: 2px dashed #28a745 !important;
}
.plant-item.dragging {
    opacity: 0.5;
}
.plant-item {
    transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
}
.plant-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    background-color: #e9ecef !important;
}
/* Remove any Bootstrap tooltip/popover effects */
.garden-cell [title]:hover::after,
.plant-item [title]:hover::after {
    display: none !important;
}
/* Make card shadows permanent and stronger, prevent movement */
.card {
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.15) !important;
    transition: none !important;
    transform: none !important;
}
.card:hover {
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.15) !important;
    transform: none !important;
}
</style>
{% endblock %}

{% block extra_js %}
{% if can_edit %}
<script>
// Plant map for symbol and color lookup
const plantMap = {{ plant_map_json|safe }};

document.addEventListener('DOMContentLoaded', function() {
    let draggedPlant = null;
    let draggedCell = null;
    let hasUnsavedChanges = false;

    // Get CSRF token
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
               document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    }

    // Extract plant data from cell
    function getPlantDataFromCell(cell) {
        const plantName = cell.dataset.plant;
        const contentSpan = cell.querySelector('.cell-content');

        if (!plantName || plantName === '' || plantName === 'empty space') {
            return null;
        }

        // Try to get color from the span
        let color = contentSpan.style.backgroundColor || '#90EE90';

        return {
            name: plantName,
            symbol: contentSpan.textContent.trim(),
            color: color
        };
    }

    // Drag start for plant library items
    const plantItems = document.querySelectorAll('.plant-item.draggable');
    plantItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            draggedPlant = {
                name: this.dataset.plantName,
                symbol: this.dataset.plantSymbol,
                color: this.dataset.plantColor
            };
            draggedCell = null;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
        });

        item.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });

    // Setup garden cell drag handlers
    function setupGardenCellDrag(cell) {
        // Make cells draggable if they have plants
        cell.setAttribute('draggable', 'true');

        cell.addEventListener('dragstart', function(e) {
            const plantData = getPlantDataFromCell(this);
            if (plantData) {
                draggedPlant = plantData;
                draggedCell = this;
                this.style.opacity = '0.4';
                e.dataTransfer.effectAllowed = 'move';
            } else {
                e.preventDefault();
            }
        });

        cell.addEventListener('dragend', function(e) {
            this.style.opacity = '1';

            // Check if the drop happened outside the garden grid (drag-off removal)
            if (draggedCell) {
                const gardenGrid = document.getElementById('gardenGrid');
                const rect = gardenGrid.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;

                // If coordinates are outside the grid bounds and not dropped on another cell
                // (we check by seeing if the drag operation completed without a drop event)
                const isOutsideGrid = x < rect.left || x > rect.right || y < rect.top || y > rect.bottom;

                if (isOutsideGrid && draggedCell === this) {
                    // Make the cell empty - plant was dragged off the grid
                    updateCellContent(this, {
                        name: 'empty space',
                        symbol: '•',
                        color: '#8FBC8F'
                    });
                    this.dataset.plant = 'empty space';

                    // Auto-save the layout
                    autoSaveLayout();
                }
            }

            draggedCell = null;
        });

        cell.addEventListener('dragover', function(e) {
            e.preventDefault();
            if (draggedCell) {
                e.dataTransfer.dropEffect = 'move';
            } else {
                e.dataTransfer.dropEffect = 'copy';
            }
            this.classList.add('drag-over');
        });

        cell.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        cell.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedPlant) {
                // If dragging from another cell, swap or move
                if (draggedCell && draggedCell !== this) {
                    const targetPlantData = getPlantDataFromCell(this);

                    // Update target cell with dragged plant
                    updateCellContent(this, draggedPlant);
                    this.dataset.plant = draggedPlant.name;

                    // Update source cell with target's plant (swap) or make it empty
                    if (targetPlantData) {
                        updateCellContent(draggedCell, targetPlantData);
                        draggedCell.dataset.plant = targetPlantData.name;
                    } else {
                        // Make source cell empty
                        updateCellContent(draggedCell, {
                            name: 'empty space',
                            symbol: '•',
                            color: '#8FBC8F'
                        });
                        draggedCell.dataset.plant = 'empty space';
                    }
                } else if (!draggedCell) {
                    // Dragging from plant library
                    updateCellContent(this, draggedPlant);
                    this.dataset.plant = draggedPlant.name;
                }

                // Auto-save the layout
                autoSaveLayout();
            }
        });
    }

    // Setup all garden cells
    const gardenCells = document.querySelectorAll('.garden-cell.droppable');
    gardenCells.forEach(cell => {
        setupGardenCellDrag(cell);
    });

    // Update cell content visually
    function updateCellContent(cell, plant) {
        const contentSpan = cell.querySelector('.cell-content');

        if (plant.name === 'empty space') {
            contentSpan.className = 'cell-content badge bg-light text-muted w-100 h-100 d-flex align-items-center justify-content-center';
            contentSpan.style.fontSize = '1.5rem';
            contentSpan.style.borderRadius = '4px';
            contentSpan.textContent = '•';
            contentSpan.title = 'Empty Space';
        } else if (plant.name === 'path') {
            contentSpan.className = 'cell-content badge bg-secondary w-100 h-100 d-flex align-items-center justify-content-center';
            contentSpan.style.fontSize = '1.5rem';
            contentSpan.style.borderRadius = '4px';
            contentSpan.textContent = '=';
            contentSpan.title = 'Path';
        } else {
            // Use symbol from plant data, fallback to first letter
            const plantSymbol = plant.symbol || plant.name.substring(0, 1).toUpperCase();

            contentSpan.className = 'cell-content badge w-100 h-100 d-flex align-items-center justify-content-center';
            contentSpan.style.backgroundColor = plant.color || '#90EE90';
            contentSpan.style.color = 'white';
            contentSpan.style.fontSize = '1.8rem';
            contentSpan.style.fontWeight = 'bold';
            contentSpan.style.borderRadius = '4px';
            contentSpan.textContent = plantSymbol;
            contentSpan.title = plant.name;
        }
    }

    // Garden name inline editing
    const gardenNameDisplay = document.getElementById('gardenNameDisplay');
    const gardenNameInput = document.getElementById('gardenNameInput');
    const gardenNameSaveStatus = document.getElementById('gardenNameSaveStatus');

    if (gardenNameDisplay && gardenNameInput) {
        // Click to edit
        gardenNameDisplay.addEventListener('click', function() {
            gardenNameDisplay.classList.add('d-none');
            gardenNameInput.classList.remove('d-none');
            gardenNameInput.focus();
            gardenNameInput.select();
        });

        // Save on blur (when user clicks away)
        gardenNameInput.addEventListener('blur', function() {
            saveGardenName();
        });

        // Save on Enter key
        gardenNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur(); // Trigger the blur event to save
            }
        });

        // Cancel on Escape key
        gardenNameInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                e.preventDefault();
                gardenNameInput.value = gardenNameDisplay.textContent.trim().replace(/\s+/g, ' ');
                gardenNameInput.classList.add('d-none');
                gardenNameDisplay.classList.remove('d-none');
            }
        });
    }

    function saveGardenName() {
        const newName = gardenNameInput.value.trim();

        // Get the old name without the pencil icon
        const displayText = gardenNameDisplay.childNodes[0].textContent.trim();

        if (newName === '' || newName === displayText) {
            // No change or empty, just revert
            gardenNameInput.classList.add('d-none');
            gardenNameDisplay.classList.remove('d-none');
            return;
        }

        // Show saving status
        gardenNameSaveStatus.textContent = 'Saving...';
        gardenNameSaveStatus.className = 'badge bg-info ms-2';

        const gardenId = {{ garden.pk }};

        fetch(`/gardens/${gardenId}/update-name/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ name: newName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update display - preserve the structure with the pencil icon
                const textNode = document.createTextNode(newName + ' ');
                const icon = document.createElement('i');
                icon.className = 'bi bi-pencil-square ms-2';
                icon.style.fontSize = '0.7em';
                icon.style.color = '#6c757d';

                gardenNameDisplay.innerHTML = '';
                gardenNameDisplay.appendChild(textNode);
                gardenNameDisplay.appendChild(icon);

                gardenNameInput.classList.add('d-none');
                gardenNameDisplay.classList.remove('d-none');

                // Show success
                gardenNameSaveStatus.textContent = 'Saved';
                gardenNameSaveStatus.className = 'badge bg-success ms-2';
                setTimeout(() => {
                    gardenNameSaveStatus.textContent = '';
                }, 2000);
            } else {
                gardenNameSaveStatus.textContent = 'Error: ' + (data.error || 'Failed to save');
                gardenNameSaveStatus.className = 'badge bg-danger ms-2';
                // Keep the input visible so user can try again
            }
        })
        .catch(error => {
            console.error('Error:', error);
            gardenNameSaveStatus.textContent = 'Network error';
            gardenNameSaveStatus.className = 'badge bg-danger ms-2';
        });
    }

    // Auto-save garden layout
    function autoSaveLayout() {
        const grid = [];
        const rows = document.querySelectorAll('#gardenGrid tr');

        rows.forEach(row => {
            const rowData = [];
            const cells = row.querySelectorAll('.garden-cell');
            cells.forEach(cell => {
                rowData.push(cell.dataset.plant || 'empty space');
            });
            grid.push(rowData);
        });

        const gardenId = {{ garden.pk }};
        const saveStatus = document.getElementById('saveStatus');

        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'badge bg-info ms-2';

        fetch(`/gardens/${gardenId}/save-layout/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ grid: grid })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                hasUnsavedChanges = false;
                saveStatus.textContent = 'Saved';
                saveStatus.className = 'badge bg-success ms-2';
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 2000);
            } else {
                saveStatus.textContent = 'Error: ' + (data.error || 'Failed to save');
                saveStatus.className = 'badge bg-danger ms-2';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveStatus.textContent = 'Network error';
            saveStatus.className = 'badge bg-danger ms-2';
        });
    }

    // Delete garden button handler
    const deleteGardenBtn = document.getElementById('deleteGardenBtn');
    if (deleteGardenBtn) {
        deleteGardenBtn.addEventListener('click', function() {
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        });
    }

    // Duplicate garden button handler
    const duplicateGardenBtn = document.getElementById('duplicateGardenBtn');
    if (duplicateGardenBtn) {
        duplicateGardenBtn.addEventListener('click', function() {
            const gardenId = {{ garden.pk }};

            // Show loading state
            duplicateGardenBtn.disabled = true;
            duplicateGardenBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Duplicating...';

            fetch(`/gardens/${gardenId}/duplicate/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to the new garden
                    window.location.href = `/gardens/${data.garden_id}/`;
                } else {
                    alert('Error: ' + (data.error || 'Failed to duplicate garden'));
                    duplicateGardenBtn.disabled = false;
                    duplicateGardenBtn.innerHTML = '<i class="bi bi-copy"></i> Duplicate';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error: Failed to duplicate garden');
                duplicateGardenBtn.disabled = false;
                duplicateGardenBtn.innerHTML = '<i class="bi bi-copy"></i> Duplicate';
            });
        });
    }

    // AI Assistant button handler
    const aiAssistantBtn = document.getElementById('aiAssistantBtn');
    const aiAssistantModal = new bootstrap.Modal(document.getElementById('aiAssistantModal'));
    let currentSuggestions = [];

    if (aiAssistantBtn) {
        aiAssistantBtn.addEventListener('click', function() {
            // Show modal with loading state
            document.getElementById('aiLoadingState').classList.remove('d-none');
            document.getElementById('aiSuggestionsContent').classList.add('d-none');
            document.getElementById('aiErrorState').classList.add('d-none');
            document.getElementById('applyAllSuggestionsBtn').disabled = true;

            aiAssistantModal.show();

            // Call AI endpoint
            const gardenId = {{ garden.pk }};

            fetch(`/gardens/${gardenId}/ai-suggest/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('aiLoadingState').classList.add('d-none');

                if (data.success && data.suggestions) {
                    // Display suggestions
                    currentSuggestions = data.suggestions.suggestions || [];
                    const reasoning = data.suggestions.reasoning || 'No strategy provided.';

                    document.getElementById('aiReasoning').textContent = reasoning;

                    const suggestionsList = document.getElementById('aiSuggestionsList');
                    suggestionsList.innerHTML = '';

                    if (currentSuggestions.length === 0) {
                        suggestionsList.innerHTML = '<div class="alert alert-info">No suggestions available. Your garden might already be well-planned!</div>';
                    } else {
                        currentSuggestions.forEach((suggestion, index) => {
                            const plantInfo = plantMap[suggestion.plant_name.toLowerCase()];
                            const symbol = plantInfo ? plantInfo.symbol : suggestion.plant_name[0].toUpperCase();
                            const color = plantInfo ? plantInfo.color : '#90EE90';

                            const item = document.createElement('div');
                            item.className = 'list-group-item d-flex align-items-center';
                            item.innerHTML = `
                                <div class="d-flex align-items-center justify-content-center me-3"
                                     style="min-width: 40px; min-height: 40px; background-color: ${color}; color: white; font-size: 1.2rem; font-weight: bold; border-radius: 4px;">
                                    ${symbol}
                                </div>
                                <div class="flex-grow-1">
                                    <strong>${suggestion.plant_name}</strong> at Row ${suggestion.row}, Col ${suggestion.col}
                                    <br>
                                    <small class="text-muted">${suggestion.reason}</small>
                                </div>
                            `;
                            suggestionsList.appendChild(item);
                        });

                        document.getElementById('applyAllSuggestionsBtn').disabled = false;
                    }

                    document.getElementById('aiSuggestionsContent').classList.remove('d-none');
                } else {
                    // Show error
                    document.getElementById('aiErrorMessage').textContent = data.error || 'Failed to get AI suggestions';
                    document.getElementById('aiErrorState').classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('aiLoadingState').classList.add('d-none');

                // Check if this is a structured error response from our backend
                if (error.error_type) {
                    const errorContainer = document.getElementById('aiErrorMessage');
                    const message = error.message || error.error;

                    // Add a link to profile settings for API key errors
                    if (error.error_type === 'no_api_key' || error.error_type === 'invalid_api_key') {
                        errorContainer.innerHTML = `
                            ${message}
                            <br><br>
                            <a href="{% url 'accounts:profile' %}" class="btn btn-warning btn-sm">
                                <i class="bi bi-gear"></i> Go to Profile Settings
                            </a>
                        `;
                    } else {
                        errorContainer.textContent = message;
                    }
                } else {
                    // Generic error
                    document.getElementById('aiErrorMessage').textContent = error.message || 'Network error occurred';
                }

                document.getElementById('aiErrorState').classList.remove('d-none');
            });
        });
    }

    // Apply all suggestions button
    const applyAllSuggestionsBtn = document.getElementById('applyAllSuggestionsBtn');
    if (applyAllSuggestionsBtn) {
        applyAllSuggestionsBtn.addEventListener('click', function() {
            if (currentSuggestions.length === 0) return;

            // Apply each suggestion to the grid
            currentSuggestions.forEach(suggestion => {
                const plantName = suggestion.plant_name.toLowerCase();
                const row = suggestion.row;
                const col = suggestion.col;

                // Find the cell
                const cell = document.querySelector(`.garden-cell[data-row="${row}"][data-col="${col}"]`);
                if (cell) {
                    const plantInfo = plantMap[plantName];
                    if (plantInfo) {
                        updateCellContent(cell, {
                            name: plantName,
                            symbol: plantInfo.symbol,
                            color: plantInfo.color
                        });
                        cell.dataset.plant = plantName;
                    }
                }
            });

            // Auto-save the layout
            autoSaveLayout();

            // Close modal
            aiAssistantModal.hide();

            // Show success message
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = 'AI suggestions applied!';
            saveStatus.className = 'badge bg-success ms-2';
            setTimeout(() => {
                saveStatus.textContent = '';
            }, 3000);
        });
    }
});
</script>
{% endif %}
{% endblock %}